<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Budgeto - Expense Tracker</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />

  <!-- Theme Color -->
  <meta name="theme-color" content="#ec4899" />

  <!-- iOS Specific -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Budgeto" />

  <!-- Apple Touch Icons - Multiple sizes for best compatibility -->
  <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-180x180.png" />
  <link rel="apple-touch-icon" sizes="152x152" href="icons/icon-152x152.png" />
  <link rel="apple-touch-icon" sizes="144x144" href="icons/icon-144x144.png" />
  <link rel="apple-touch-icon" sizes="120x120" href="icons/icon-192x192.png" />
  <link rel="apple-touch-icon" sizes="114x114" href="icons/icon-192x192.png" />
  <link rel="apple-touch-icon" sizes="76x76" href="icons/icon-96x96.png" />
  <link rel="apple-touch-icon" sizes="72x72" href="icons/icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="60x60" href="icons/icon-72x72.png" />
  <link rel="apple-touch-icon" sizes="57x57" href="icons/icon-72x72.png" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192x192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512x512.png" />
  <link rel="shortcut icon" href="favicon.ico" />

  <!-- Tailwind CSS (Ïä§ÌÉÄÏùºÎßÅ ÎèÑÍµ¨) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Import Map: Î∏åÎùºÏö∞Ï†ÄÍ∞Ä ÎùºÏù¥Î∏åÎü¨Î¶¨ ÏúÑÏπòÎ•º Ï∞æÏùÑ Ïàò ÏûàÍ≤å ÎèÑÏôÄÏ§çÎãàÎã§ -->
  <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
      }
    </script>

  <!-- Babel: JSX ÏΩîÎìúÎ•º Î∏åÎùºÏö∞Ï†ÄÍ∞Ä Ïù¥Ìï¥Ìï† Ïàò ÏûàÍ≤å Î≥ÄÌôòÌï©ÎãàÎã§ -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    /* Ï∂îÍ∞ÄÏ†ÅÏù∏ Ïª§Ïä§ÌÖÄ Ïä§ÌÉÄÏùºÏù¥ ÌïÑÏöîÌïòÎã§Î©¥ Ïó¨Í∏∞Ïóê ÏûëÏÑ±Ìï©ÎãàÎã§ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
        "Helvetica Neue", Arial, sans-serif;
    }

    /* Ïä§Ï∫î Ïï†ÎãàÎ©îÏù¥ÏÖò */
    @keyframes scan {
      0% {
        transform: translateY(-100%);
      }

      100% {
        transform: translateY(100%);
      }
    }
  </style>
</head>

<body class="bg-gray-100">
  <div id="root"></div>

  <script type="text/babel" data-type="module">
    import React, { useState, useEffect, useMemo, useRef } from "react";
    import { createRoot } from "react-dom/client";
    import {
      Plus,
      Trash2,
      TrendingUp,
      TrendingDown,
      X,
      PieChart,
      List,
      AlertCircle,
      Utensils,
      Car,
      Home,
      ShoppingBag,
      Tv,
      HeartPulse,
      Briefcase,
      Gift,
      MoreHorizontal,
      Coffee,
      Smartphone,
      Cookie,
      Moon,
      Sun,
      Target,
      GlassWater,
      Sparkles,
      Bone,
      ChevronLeft,
      ChevronRight,
      Calendar,
      Camera,
      ScanLine,
      Loader,
      AlertTriangle,
    } from "lucide-react";

    // --- SVG Components (Ï∫êÎ¶≠ÌÑ∞ Ïª¥Ìè¨ÎÑåÌä∏) ---

    // Base Head Component to reuse code
    const PompitHead = ({ children }) => (
      <>
        {/* Ears */}
        <path d="M20 35 L10 10 L45 25 Z" fill="#ffffff" />
        <path d="M80 35 L90 10 L55 25 Z" fill="#ffffff" />
        <path d="M22 30 L18 15 L38 25 Z" fill="#F472B6" opacity="0.5" />
        <path d="M78 30 L82 15 L62 25 Z" fill="#F472B6" opacity="0.5" />
        {/* Fluffy Head Base */}
        <circle cx="50" cy="55" r="38" fill="#ffffff" />
        <circle cx="15" cy="50" r="12" fill="#ffffff" />
        <circle cx="85" cy="50" r="12" fill="#ffffff" />
        <circle cx="30" cy="20" r="15" fill="#ffffff" />
        <circle cx="70" cy="20" r="15" fill="#ffffff" />
        {/* Cheeks */}
        <circle cx="28" cy="62" r="6" fill="#F472B6" opacity="0.3" />
        <circle cx="72" cy="62" r="6" fill="#F472B6" opacity="0.3" />
        {children}
      </>
    );

    // Standard Face
    const PompitAvatar = ({ size = 40, className = "" }) => (
      <svg
        width={size}
        height={size}
        viewBox="0 0 100 100"
        className={className}
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <PompitHead>
          <circle cx="38" cy="52" r="4.5" fill="#1e293b" />
          <circle cx="62" cy="52" r="4.5" fill="#1e293b" />
          <circle cx="40" cy="50" r="1.5" fill="white" opacity="0.9" />
          <circle cx="64" cy="50" r="1.5" fill="white" opacity="0.9" />
          <ellipse cx="50" cy="60" rx="5" ry="3.5" fill="#1e293b" />
          <path
            d="M43 68 Q50 73 57 68"
            stroke="#1e293b"
            strokeWidth="2"
            strokeLinecap="round"
          />
        </PompitHead>
      </svg>
    );

    // Happy Face (Cheering)
    const PompitHappy = ({ size = 40, className = "" }) => (
      <svg
        width={size}
        height={size}
        viewBox="0 0 100 100"
        className={className}
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <PompitHead>
          {/* Happy Eyes ^ ^ */}
          <path
            d="M32 52 L38 46 L44 52"
            stroke="#1e293b"
            strokeWidth="3"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
          <path
            d="M56 52 L62 46 L68 52"
            stroke="#1e293b"
            strokeWidth="3"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
          <ellipse cx="50" cy="60" rx="5" ry="3.5" fill="#1e293b" />
          {/* Open Mouth */}
          <path
            d="M40 68 Q50 80 60 68 Z"
            fill="#F472B6"
            stroke="#1e293b"
            strokeWidth="1"
          />
          {/* Sparkles */}
          <path
            d="M85 35 L87 30 L89 35 L94 37 L89 39 L87 44 L85 39 L80 37 Z"
            fill="#F43F5E"
          />
        </PompitHead>
      </svg>
    );

    // Sad Face (Worried/Sweating)
    const PompitSad = ({ size = 40, className = "" }) => (
      <svg
        width={size}
        height={size}
        viewBox="0 0 100 100"
        className={className}
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <PompitHead>
          {/* Sad Eyes T T */}
          <path
            d="M30 52 L46 52"
            stroke="#1e293b"
            strokeWidth="3"
            strokeLinecap="round"
          />
          <path
            d="M38 52 L38 58"
            stroke="#1e293b"
            strokeWidth="3"
            strokeLinecap="round"
          />
          <path
            d="M54 52 L70 52"
            stroke="#1e293b"
            strokeWidth="3"
            strokeLinecap="round"
          />
          <path
            d="M62 52 L62 58"
            stroke="#1e293b"
            strokeWidth="3"
            strokeLinecap="round"
          />
          <ellipse cx="50" cy="62" rx="5" ry="3.5" fill="#1e293b" />
          {/* Wobbly Mouth */}
          <path
            d="M42 72 Q50 68 58 72"
            stroke="#1e293b"
            strokeWidth="2"
            strokeLinecap="round"
          />
          {/* Sweat Drop */}
          <path d="M80 45 Q85 55 80 60 Q75 55 80 45" fill="#60A5FA" />
        </PompitHead>
      </svg>
    );

    // Sleeping Face (No Data)
    const PompitSleeping = ({ size = 40, className = "" }) => (
      <svg
        width={size}
        height={size}
        viewBox="0 0 100 100"
        className={className}
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <PompitHead>
          {/* Closed Eyes - - */}
          <path
            d="M32 54 L44 54"
            stroke="#1e293b"
            strokeWidth="3"
            strokeLinecap="round"
          />
          <path
            d="M56 54 L68 54"
            stroke="#1e293b"
            strokeWidth="3"
            strokeLinecap="round"
          />
          <ellipse cx="50" cy="62" rx="4" ry="2.5" fill="#1e293b" />
          {/* Snot Bubble */}
          <circle
            cx="58"
            cy="65"
            r="8"
            fill="#E0F2FE"
            stroke="#38BDF8"
            strokeWidth="1"
            opacity="0.8"
          />
          <path
            d="M60 62 Q62 60 64 62"
            stroke="white"
            strokeWidth="2"
            strokeLinecap="round"
          />
          {/* Zzz */}
          <path
            d="M85 25 L95 25 L85 35 L95 35"
            stroke="#94A3B8"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
          <path
            d="M92 15 L98 15 L92 20 L98 20"
            stroke="#94A3B8"
            strokeWidth="1.5"
            strokeLinecap="round"
            strokeLinejoin="round"
          />
        </PompitHead>
      </svg>
    );

    // Scanning Face (New)
    const PompitScanning = ({ size = 40, className = "" }) => (
      <svg
        width={size}
        height={size}
        viewBox="0 0 100 100"
        className={className}
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
      >
        <PompitHead>
          {/* Concentrated Eyes */}
          <circle cx="38" cy="52" r="5" fill="#1e293b" />
          <circle cx="62" cy="52" r="5" fill="#1e293b" />
          {/* Glasses */}
          <circle
            cx="38"
            cy="52"
            r="10"
            stroke="#1e293b"
            strokeWidth="2"
            fill="none"
          />
          <circle
            cx="62"
            cy="52"
            r="10"
            stroke="#1e293b"
            strokeWidth="2"
            fill="none"
          />
          <path d="M48 52 L52 52" stroke="#1e293b" strokeWidth="2" />
          {/* Mouth */}
          <path
            d="M45 65 L55 65"
            stroke="#1e293b"
            strokeWidth="2"
            strokeLinecap="round"
          />
        </PompitHead>
      </svg>
    );

    // Translations Database
    const TRANSLATIONS = {
      en: {
        totalBalance: "Total Balance",
        income: "Income",
        expense: "Expense",
        transactions: "Transactions",
        insights: "Insights",
        recentActivity: "Recent Activity",
        records: "records",
        noData: "No transactions yet!",
        addPrompt: "Tap + to add one",
        savings: "Savings",
        biggestExpense: "Biggest Expense",
        txCount: "Tx Count",
        totalItems: "Total items",
        budget: "Budget",
        remaining: "Remaining",
        budgetExceeded: "Budget Exceeded!",
        trackingWell: "Tracking well",
        used: "used",
        setBudget: "Set Budget",
        monthlyLimit: "Monthly Limit",
        saveBudget: "Save Budget",
        newEntry: "New Entry",
        amount: "Amount",
        category: "Category",
        note: "Note",
        notePlaceholder: "Add a note...",
        addIncome: "Add Income",
        addExpense: "Add Expense",
        monthlySummary: "Monthly Summary",
        netFlow: "Net Flow",
        scanReceipt: "Scan Receipt",
        scanning: "Scanning...",
        receiptProcessed: "Receipt Scanned!",
        // Categories
        food: "Food",
        snacks: "Snacks",
        drink: "Drink",
        cafe: "Cafe",
        transport: "Transport",
        housing: "Housing",
        shopping: "Shopping",
        entertainment: "Fun",
        beauty: "Beauty",
        health: "Health",
        doggy: "Doggy",
        other: "Other",
        salary: "Salary",
        freelance: "Freelance",
        gift: "Gift",
      },
      th: {
        totalBalance: "‡∏¢‡∏≠‡∏î‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°",
        income: "‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö",
        expense: "‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢",
        transactions: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
        insights: "‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°",
        recentActivity: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
        records: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
        noData: "‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£!",
        addPrompt: "‡∏Å‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å",
        savings: "‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏≠‡∏°",
        biggestExpense: "‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î",
        txCount: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô",
        totalItems: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£",
        budget: "‡∏á‡∏ö",
        remaining: "‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠",
        budgetExceeded: "‡∏á‡∏ö‡πÄ‡∏Å‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß!",
        trackingWell: "‡∏Ñ‡∏∏‡∏°‡∏á‡∏ö‡πÑ‡∏î‡πâ‡∏î‡∏µ",
        used: "‡πÉ‡∏ä‡πâ‡πÑ‡∏õ",
        setBudget: "‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì",
        monthlyLimit: "‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
        saveBudget: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö",
        newEntry: "‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà",
        amount: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô",
        category: "‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà",
        note: "‡πÇ‡∏ô‡πâ‡∏ï",
        notePlaceholder: "‡πÉ‡∏™‡πà‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...",
        addIncome: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö",
        addExpense: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢",
        monthlySummary: "‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
        netFlow: "‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥",
        scanReceipt: "‡∏™‡πÅ‡∏Å‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à",
        scanning: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πÅ‡∏Å‡∏ô...",
        receiptProcessed: "‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!",
        // Categories
        food: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
        snacks: "‡∏Ç‡∏ô‡∏°",
        drink: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°",
        cafe: "‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà",
        transport: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
        housing: "‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å",
        shopping: "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á",
        entertainment: "‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á",
        beauty: "‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏™‡∏ß‡∏¢",
        health: "‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û",
        doggy: "‡∏ô‡πâ‡∏≠‡∏á‡∏´‡∏°‡∏≤",
        other: "‡∏≠‡∏∑‡πà‡∏ô‡πÜ",
        salary: "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
        freelance: "‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå",
        gift: "‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç",
      },
      ko: {
        totalBalance: "Ï¥ù ÏûêÏÇ∞",
        income: "ÏàòÏûÖ",
        expense: "ÏßÄÏ∂ú",
        transactions: "ÎÇ¥Ïó≠",
        insights: "ÌÜµÍ≥Ñ",
        recentActivity: "Ïù¥Î≤à Îã¨ ÎÇ¥Ïó≠",
        records: "Í±¥",
        noData: "Ïù¥Î≤à Îã¨ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§!",
        addPrompt: "+ Î≤ÑÌäºÏùÑ ÎàåÎü¨ Ï∂îÍ∞ÄÌïòÏÑ∏Ïöî",
        savings: "Ï†ÄÏ∂ïÎ•†",
        biggestExpense: "ÏµúÎåÄ ÏßÄÏ∂ú",
        txCount: "Í±∞Îûò Ïàò",
        totalItems: "Ï†ÑÏ≤¥ Ìï≠Î™©",
        budget: "ÏòàÏÇ∞",
        remaining: "ÏûîÏï°",
        budgetExceeded: "ÏòàÏÇ∞ Ï¥àÍ≥º!",
        trackingWell: "ÏòàÏÇ∞ ÎÇ¥ Í¥ÄÎ¶¨ Ï§ë",
        used: "ÏÇ¨Ïö©",
        setBudget: "ÏòàÏÇ∞ ÏÑ§Ï†ï",
        monthlyLimit: "Ïõî ÏòàÏÇ∞ ÌïúÎèÑ",
        saveBudget: "ÏòàÏÇ∞ Ï†ÄÏû•",
        newEntry: "ÏÉàÎ°úÏö¥ ÎÇ¥Ïó≠",
        amount: "Í∏àÏï°",
        category: "Ïπ¥ÌÖåÍ≥†Î¶¨",
        note: "Î©îÎ™®",
        notePlaceholder: "ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...",
        addIncome: "ÏàòÏûÖ Ï∂îÍ∞Ä",
        addExpense: "ÏßÄÏ∂ú Ï∂îÍ∞Ä",
        monthlySummary: "ÏõîÍ∞Ñ ÏöîÏïΩ",
        netFlow: "ÏàúÏàòÏùµ",
        scanReceipt: "ÏòÅÏàòÏ¶ù Ïä§Ï∫î",
        scanning: "Ïä§Ï∫î Ï§ë...",
        receiptProcessed: "ÏòÅÏàòÏ¶ù Ïù∏Ïãù ÏôÑÎ£å!",
        // Categories
        food: "ÏãùÎπÑ",
        snacks: "Í∞ÑÏãù",
        drink: "ÏùåÎ£å",
        cafe: "Ïπ¥Ìéò",
        transport: "ÍµêÌÜµ",
        housing: "Ï£ºÍ±∞",
        shopping: "ÏáºÌïë",
        entertainment: "Î¨∏Ìôî",
        beauty: "ÎØ∏Ïö©",
        health: "Í±¥Í∞ï",
        doggy: "Î∞òÎ†§Í≤¨",
        other: "Í∏∞ÌÉÄ",
        salary: "ÏõîÍ∏â",
        freelance: "ÌîÑÎ¶¨ÎûúÏÑú",
        gift: "ÏÑ†Î¨º",
      },
    };

    // Currency Configuration
    const CURRENCIES = {
      KRW: { symbol: '‚Ç©', name: 'Korean Won', flag: 'üá∞üá∑', decimals: 0 },
      USD: { symbol: '$', name: 'US Dollar', flag: 'üá∫üá∏', decimals: 2 },
      THB: { symbol: '‡∏ø', name: 'Thai Baht', flag: 'üáπüá≠', decimals: 2 }
    };

    // Category Configuration
    const CATEGORIES = {
      expense: [
        {
          id: "food",
          icon: Utensils,
          color: "text-orange-500",
          bg: "bg-orange-100",
        },
        {
          id: "snacks",
          icon: Cookie,
          color: "text-yellow-500",
          bg: "bg-yellow-100",
        },
        {
          id: "drink",
          icon: GlassWater,
          color: "text-sky-500",
          bg: "bg-sky-100",
        },
        {
          id: "cafe",
          icon: Coffee,
          color: "text-amber-700",
          bg: "bg-amber-100",
        },
        {
          id: "transport",
          icon: Car,
          color: "text-blue-500",
          bg: "bg-blue-100",
        },
        {
          id: "housing",
          icon: Home,
          color: "text-indigo-500",
          bg: "bg-indigo-100",
        },
        {
          id: "shopping",
          icon: ShoppingBag,
          color: "text-pink-500",
          bg: "bg-pink-100",
        },
        {
          id: "entertainment",
          icon: Tv,
          color: "text-purple-500",
          bg: "bg-purple-100",
        },
        {
          id: "beauty",
          icon: Sparkles,
          color: "text-fuchsia-500",
          bg: "bg-fuchsia-100",
        },
        {
          id: "health",
          icon: HeartPulse,
          color: "text-red-500",
          bg: "bg-red-100",
        },
        {
          id: "doggy",
          icon: Bone,
          color: "text-stone-500",
          bg: "bg-stone-100",
        },
        {
          id: "other",
          icon: MoreHorizontal,
          color: "text-slate-500",
          bg: "bg-slate-100",
        },
      ],
      income: [
        {
          id: "salary",
          icon: Briefcase,
          color: "text-emerald-600",
          bg: "bg-emerald-100",
        },
        {
          id: "freelance",
          icon: Smartphone,
          color: "text-cyan-600",
          bg: "bg-cyan-100",
        },
        { id: "gift", icon: Gift, color: "text-rose-500", bg: "bg-rose-100" },
        {
          id: "other",
          icon: MoreHorizontal,
          color: "text-slate-500",
          bg: "bg-slate-100",
        },
      ],
    };

    function App() {
      // State for Language
      const [language, setLanguage] = useState(() => {
        if (typeof window !== "undefined") {
          const saved = localStorage.getItem("language");
          return saved === "en" || saved === "th" || saved === "ko"
            ? saved
            : "th";
        }
        return "th";
      });

      // State for Currency
      const [currency, setCurrency] = useState(() => {
        if (typeof window !== "undefined") {
          const saved = localStorage.getItem("currency");
          return saved === "KRW" || saved === "USD" || saved === "THB" ? saved : "KRW";
        }
        return "KRW";
      });
      const [isCurrencyModalOpen, setIsCurrencyModalOpen] = useState(false);
      const [exchangeRates, setExchangeRates] = useState({
        KRW: 1,
        USD: 1,
        THB: 1
      });
      const [ratesLoading, setRatesLoading] = useState(true);

      // State for Date Navigation
      const [currentDate, setCurrentDate] = useState(new Date());

      // State for Dark Mode
      const [isDark, setIsDark] = useState(() => {
        if (typeof window !== "undefined") {
          return localStorage.getItem("theme") === "dark";
        }
        return false;
      });

      // State for Budget
      const [budget, setBudget] = useState(() => {
        if (typeof window !== "undefined") {
          const saved = localStorage.getItem("expense_tracker_budget");
          return saved ? parseFloat(saved) : 0;
        }
        return 0;
      });
      const [isBudgetOpen, setIsBudgetOpen] = useState(false);
      const [tempBudget, setTempBudget] = useState("");

      // State for storing transactions
      const [transactions, setTransactions] = useState(() => {
        const saved = localStorage.getItem("expense_tracker_data");
        if (saved) {
          const parsed = JSON.parse(saved);
          // Migration logic kept for robustness
          return parsed.map((t) => {
            let category = t.category;
            if (category === "other_inc" || category === "other_exp")
              category = "other";
            if (category === "coffee") category = "drink";
            return {
              ...t,
              category,
              currency: t.currency || "KRW", // Default to KRW for old transactions
              timestamp: t.timestamp || new Date().getTime(),
            };
          });
        }
        return [];
      });

      // State for form inputs
      const [text, setText] = useState("");
      const [amount, setAmount] = useState("");
      const [formType, setFormType] = useState("expense");
      const [selectedCategory, setSelectedCategory] = useState("food");
      const [isFormVisible, setIsFormVisible] = useState(false);
      const [activeTab, setActiveTab] = useState("transactions");

      // Scanning State
      const [isScanning, setIsScanning] = useState(false);
      const fileInputRef = useRef(null);

      // Persistence Effects
      useEffect(() => {
        localStorage.setItem("theme", isDark ? "dark" : "light");
      }, [isDark]);
      useEffect(() => {
        localStorage.setItem("language", language);
      }, [language]);
      useEffect(() => {
        localStorage.setItem("expense_tracker_budget", budget.toString());
      }, [budget]);
      useEffect(() => {
        localStorage.setItem(
          "expense_tracker_data",
          JSON.stringify(transactions)
        );
      }, [transactions]);
      useEffect(() => {
        localStorage.setItem("currency", currency);
      }, [currency]);

      // Fetch Exchange Rates
      useEffect(() => {
        const fetchRates = async () => {
          try {
            setRatesLoading(true);
            const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
            const data = await response.json();
            setExchangeRates({
              KRW: data.rates.KRW || 1300,
              USD: 1,
              THB: data.rates.THB || 35
            });
          } catch (error) {
            console.error('Failed to fetch exchange rates:', error);
            // Fallback rates
            setExchangeRates({ KRW: 1300, USD: 1, THB: 35 });
          } finally {
            setRatesLoading(false);
          }
        };
        fetchRates();
        // Refresh rates every 1 hour
        const interval = setInterval(fetchRates, 3600000);
        return () => clearInterval(interval);
      }, []);

      // Derived calculations

      // 1. Filter Transactions by Month
      const filteredTransactions = useMemo(() => {
        return transactions
          .filter((t) => {
            const tDate = new Date(t.timestamp);
            return (
              tDate.getMonth() === currentDate.getMonth() &&
              tDate.getFullYear() === currentDate.getFullYear()
            );
          })
          .sort((a, b) => b.timestamp - a.timestamp);
      }, [transactions, currentDate]);

      // 2. Global Total Balance (All time) - Convert all to KRW for calculation
      const globalBalance = useMemo(() => {
        const incomeTotal = transactions
          .filter((item) => item.type === "income")
          .reduce((acc, item) => acc + convertAmount(item.amount, item.currency || 'KRW', 'KRW'), 0);
        const expenseTotal = transactions
          .filter((item) => item.type === "expense")
          .reduce((acc, item) => acc + convertAmount(item.amount, item.currency || 'KRW', 'KRW'), 0);
        return (incomeTotal - expenseTotal).toFixed(2);
      }, [transactions, exchangeRates]);

      // 3. Monthly Stats - Convert all to KRW for calculation
      const {
        monthlyIncome,
        monthlyExpense,
        monthlyIncomeNum,
        monthlyExpenseNum,
      } = useMemo(() => {
        const incomeNum = filteredTransactions
          .filter((item) => item.type === "income")
          .reduce((acc, item) => acc + convertAmount(item.amount, item.currency || 'KRW', 'KRW'), 0);

        const expenseNum = filteredTransactions
          .filter((item) => item.type === "expense")
          .reduce((acc, item) => acc + convertAmount(item.amount, item.currency || 'KRW', 'KRW'), 0);

        return {
          monthlyIncome: incomeNum.toFixed(2),
          monthlyExpense: expenseNum.toFixed(2),
          monthlyIncomeNum: incomeNum,
          monthlyExpenseNum: expenseNum,
        };
      }, [filteredTransactions, exchangeRates]);

      // Budget Calculations (Based on Monthly Expense)
      const remainingBudget = (budget - monthlyExpenseNum).toFixed(2);
      const percentUsed = budget > 0 ? (monthlyExpenseNum / budget) * 100 : 0;

      const getProgressColor = () => {
        if (percentUsed > 90) return "bg-red-400";
        if (percentUsed > 75) return "bg-orange-400";
        return "bg-emerald-400";
      };

      const highestExpense = useMemo(() => {
        const expenses = filteredTransactions.filter(
          (t) => t.type === "expense"
        );
        if (expenses.length === 0)
          return { text: TRANSLATIONS[language].noData, amount: 0 };
        return expenses.reduce((max, current) =>
          current.amount > max.amount ? current : max
        );
      }, [filteredTransactions, language]);

      const savingsRate = useMemo(() => {
        if (monthlyIncomeNum === 0) return 0;
        return Math.max(
          0,
          ((monthlyIncomeNum - monthlyExpenseNum) / monthlyIncomeNum) * 100
        ).toFixed(0);
      }, [monthlyIncomeNum, monthlyExpenseNum]);

      // Helper: Get Translated Text
      const t = (key) => TRANSLATIONS[language][key];

      // Helper: Convert amount between currencies
      const convertAmount = (amount, fromCurrency = 'KRW', toCurrency = currency) => {
        if (fromCurrency === toCurrency) return amount;
        // Convert to USD first, then to target currency
        const amountInUSD = amount / exchangeRates[fromCurrency];
        return amountInUSD * exchangeRates[toCurrency];
      };

      // Helper: Format Currency with thousand separator
      const formatCurrency = (amount, currencyCode = currency) => {
        const number = typeof amount === 'string' ? parseFloat(amount) : amount;
        const decimals = CURRENCIES[currencyCode]?.decimals || 2;
        return number.toLocaleString('en-US', {
          minimumFractionDigits: decimals,
          maximumFractionDigits: decimals
        });
      };

      // Helper: Get currency symbol
      const getCurrencySymbol = () => CURRENCIES[currency]?.symbol || '‚Ç©';


      // Helper: Get Date Locale
      const getDateLocale = () => {
        if (language === "ko") return "ko-KR";
        if (language === "th") return "th-TH";
        return "en-US";
      };

      // Month Navigation Handlers
      const prevMonth = () => {
        setCurrentDate(
          new Date(currentDate.setMonth(currentDate.getMonth() - 1))
        );
      };
      const nextMonth = () => {
        setCurrentDate(
          new Date(currentDate.setMonth(currentDate.getMonth() + 1))
        );
      };

      // Handlers
      const saveBudget = (e) => {
        e.preventDefault();
        if (tempBudget) setBudget(parseFloat(tempBudget));
        setIsBudgetOpen(false);
      };

      const addTransaction = (e) => {
        e.preventDefault();
        if (!text || !amount) return;

        const now = new Date();

        const newTransaction = {
          id: Math.floor(Math.random() * 100000000),
          text,
          amount: +amount,
          type: formType,
          category: selectedCategory,
          currency: currency, // Use current display currency
          timestamp: now.getTime(),
          date: now.toLocaleDateString(getDateLocale(), {
            month: "short",
            day: "numeric",
            year: language === "ko" ? "numeric" : undefined,
          }),
        };

        setTransactions([newTransaction, ...transactions]);
        setCurrentDate(new Date());
        setText("");
        setAmount("");
        setIsFormVisible(false);
      };

      const deleteTransaction = (id) => {
        setTransactions(
          transactions.filter((transaction) => transaction.id !== id)
        );
      };

      const openForm = () => {
        setFormType("expense");
        setSelectedCategory("food");
        setText("");
        setAmount("");
        setIsFormVisible(true);
      };

      const handleCameraCapture = (e) => {
        if (e.target.files && e.target.files[0]) {
          setIsScanning(true);
          setTimeout(() => {
            setIsScanning(false);
            const simulatedAmount = Math.floor(Math.random() * 500) + 50;
            setAmount(simulatedAmount.toString());
            setText(t("receiptProcessed"));
            setFormType("expense");
            setSelectedCategory("shopping");
            setIsFormVisible(true);
          }, 2000);
        }
      };

      const triggerCamera = () => {
        fileInputRef.current?.click();
      };

      const getCategoryDetails = (catId, type) => {
        const allCats = [...CATEGORIES.income, ...CATEGORIES.expense];
        const cat = allCats.find((c) => c.id === catId);
        const label = TRANSLATIONS[language][catId] || catId;

        if (cat) return { ...cat, label };
        return type === "income"
          ? {
            icon: TrendingUp,
            color: "text-green-600",
            bg: "bg-green-100",
            label,
          }
          : {
            icon: TrendingDown,
            color: "text-red-600",
            bg: "bg-red-100",
            label,
          };
      };

      const toggleLanguage = () => {
        let newLanguage;
        let newCurrency;

        if (language === "th") {
          newLanguage = "en";
          newCurrency = "USD";
        } else if (language === "en") {
          newLanguage = "ko";
          newCurrency = "KRW";
        } else {
          newLanguage = "th";
          newCurrency = "THB";
        }

        setLanguage(newLanguage);
        setCurrency(newCurrency);
      };

      // SVG Chart
      const DonutChart = () => {
        const totalVolume = monthlyIncomeNum + monthlyExpenseNum;
        if (totalVolume === 0)
          return (
            <div
              className={`h-48 flex items-center justify-center flex-col gap-2 ${isDark ? "text-slate-600" : "text-slate-300"
                }`}
            >
              <PieChart size={48} className="opacity-20" />
              <span className="text-sm">{t("noData")}</span>
            </div>
          );

        const radius = 70;
        const circumference = 2 * Math.PI * radius;
        const expensePercent = monthlyExpenseNum / totalVolume;
        const expenseDash = expensePercent * circumference;

        return (
          <div className="relative h-64 flex items-center justify-center">
            <svg
              viewBox="0 0 200 200"
              className="w-48 h-48 transform -rotate-90"
            >
              <circle
                cx="100"
                cy="100"
                r={radius}
                fill="none"
                stroke={isDark ? "#3b82f6" : "#60a5fa"}
                strokeWidth="20"
              />
              <circle
                cx="100"
                cy="100"
                r={radius}
                fill="none"
                stroke={isDark ? "#ec4899" : "#f472b6"}
                strokeWidth="20"
                strokeDasharray={`${expenseDash} ${circumference}`}
                strokeLinecap="round"
              />
            </svg>
            <div className="absolute flex flex-col items-center">
              <div className="mb-1">
                {parseInt(savingsRate) > 20 ? (
                  <PompitHappy size={40} />
                ) : parseInt(savingsRate) < 5 && monthlyExpenseNum > 0 ? (
                  <PompitSad size={40} />
                ) : (
                  <span
                    className={`text-xs font-semibold uppercase ${isDark ? "text-slate-400" : "text-slate-400"
                      }`}
                  >
                    {t("savings")}
                  </span>
                )}
              </div>
              <span className="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-violet-500">
                {savingsRate}%
              </span>
            </div>
            <div className="absolute bottom-0 w-full flex justify-center gap-6 text-xs font-bold">
              <div
                className={`flex items-center gap-1 ${isDark ? "text-slate-300" : "text-slate-600"
                  }`}
              >
                <div className="w-3 h-3 bg-blue-400 rounded-full"></div>{" "}
                {t("income")}
              </div>
              <div
                className={`flex items-center gap-1 ${isDark ? "text-slate-300" : "text-slate-600"
                  }`}
              >
                <div className="w-3 h-3 bg-pink-400 rounded-full"></div>{" "}
                {t("expense")}
              </div>
            </div>
          </div>
        );
      };

      return (
        <div
          className={`min-h-screen font-sans transition-colors duration-300 ${isDark
            ? "bg-slate-900 text-slate-100"
            : "bg-slate-50 text-slate-800"
            }`}
        >
          <div
            className={`max-w-md mx-auto min-h-screen shadow-2xl overflow-hidden relative flex flex-col transition-colors duration-300 ${isDark ? "bg-slate-900 shadow-black/50" : "bg-white"
              }`}
          >
            {/* Hidden File Input for Camera */}
            <input
              type="file"
              accept="image/*"
              capture="environment"
              ref={fileInputRef}
              className="hidden"
              onChange={handleCameraCapture}
            />

            {/* Header with Rainbow Gradient */}
            <div
              className={`text-white p-6 rounded-b-[2.5rem] shadow-xl z-10 transition-colors duration-300 ${isDark
                ? "bg-gradient-to-r from-pink-600 via-purple-600 to-indigo-600"
                : "bg-gradient-to-r from-pink-400 via-purple-400 to-indigo-400"
                }`}
            >
              <div className="flex justify-between items-center mb-6">
                <h2 className="text-xl font-bold flex items-center gap-2">
                  <div className="bg-white/20 p-1.5 rounded-full backdrop-blur-md">
                    <PompitAvatar size={32} />
                  </div>
                  Budgeto
                </h2>

                <div className="flex items-center gap-2">
                  <button
                    onClick={toggleLanguage}
                    className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors backdrop-blur-md flex items-center justify-center font-bold text-xs w-9 h-9"
                    aria-label="Change Language"
                  >
                    {language.toUpperCase()}
                  </button>
                  <button
                    onClick={() => setIsCurrencyModalOpen(true)}
                    className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors backdrop-blur-md flex items-center justify-center font-bold text-lg w-9 h-9"
                    aria-label="Change Currency"
                  >
                    {getCurrencySymbol()}
                  </button>
                  <button
                    onClick={() => {
                      setIsBudgetOpen(true);
                      setTempBudget(budget.toString());
                    }}
                    className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors backdrop-blur-md"
                    aria-label="Set Budget"
                  >
                    <Target size={18} />
                  </button>
                  <button
                    onClick={() => setIsDark(!isDark)}
                    className="p-2 bg-white/20 rounded-full hover:bg-white/30 transition-colors backdrop-blur-md"
                    aria-label="Toggle Theme"
                  >
                    {isDark ? <Sun size={18} /> : <Moon size={18} />}
                  </button>
                </div>
              </div>

              <div className="flex flex-col items-center mb-6">
                <p className="text-pink-100 text-sm mb-1 font-medium">
                  {t("totalBalance")}
                </p>
                <h1 className="text-4xl font-black tracking-tight mb-4">
                  {getCurrencySymbol()}{formatCurrency(convertAmount(parseFloat(globalBalance)))}
                </h1>

                {/* Month Navigator */}
                <div className="flex items-center gap-4 bg-white/20 px-4 py-2 rounded-full backdrop-blur-md">
                  <button
                    onClick={prevMonth}
                    className="hover:text-pink-200 transition-colors"
                  >
                    <ChevronLeft size={20} />
                  </button>
                  <div className="flex items-center gap-2 font-bold min-w-[120px] justify-center">
                    <Calendar size={16} />
                    {currentDate.toLocaleDateString(getDateLocale(), {
                      month: "long",
                      year: "numeric",
                    })}
                  </div>
                  <button
                    onClick={nextMonth}
                    className="hover:text-pink-200 transition-colors"
                  >
                    <ChevronRight size={20} />
                  </button>
                </div>
              </div>

              {/* Budget Progress Section */}
              {budget > 0 && (
                <div className="mb-6 bg-white/20 p-4 rounded-2xl backdrop-blur-md border border-white/20 shadow-sm animate-in fade-in slide-in-from-top-2 relative overflow-hidden">
                  {/* Decorative Pompit */}
                  <div className="absolute right-2 top-0 opacity-20 transform rotate-12">
                    {percentUsed > 100 ? (
                      <PompitSad size={60} />
                    ) : (
                      <PompitHappy size={60} />
                    )}
                  </div>

                  <div className="flex justify-between text-xs text-white/90 font-bold mb-2 relative z-10">
                    <span className="flex items-center gap-1">
                      <Target size={12} /> {t("budget")}: {getCurrencySymbol()}{formatCurrency(convertAmount(budget))}
                    </span>
                    <span>
                      {t("remaining")}: {getCurrencySymbol()}{formatCurrency(convertAmount(parseFloat(remainingBudget)))}
                    </span>
                  </div>
                  <div className="h-3 bg-black/20 rounded-full overflow-hidden relative z-10">
                    <div
                      className={`h-full transition-all duration-700 ease-out ${getProgressColor()}`}
                      style={{ width: `${Math.min(percentUsed, 100)}%` }}
                    />
                  </div>
                  <div className="flex justify-between mt-1 relative z-10">
                    <p className="text-[10px] text-white/70 font-medium flex items-center gap-1">
                      {percentUsed >= 100 ? (
                        <>
                          <AlertTriangle size={10} className="text-red-200" />{" "}
                          {t("budgetExceeded")}
                        </>
                      ) : (
                        <>
                          <Sparkles size={10} className="text-emerald-200" />{" "}
                          {t("trackingWell")}
                        </>
                      )}
                    </p>
                    <p className="text-[10px] text-white/80 font-medium">
                      {t("used")} {percentUsed.toFixed(0)}%
                    </p>
                  </div>
                </div>
              )}

              <div className="flex gap-4 mt-4">
                <div className="flex-1 bg-white/20 p-3 rounded-2xl backdrop-blur-md border border-white/20">
                  <p className="text-white/90 text-xs uppercase tracking-wider mb-1 font-bold">
                    {t("income")}
                  </p>
                  <p className="text-lg font-bold">{getCurrencySymbol()}{formatCurrency(convertAmount(monthlyIncomeNum))}</p>
                </div>
                <div className="flex-1 bg-white/20 p-3 rounded-2xl backdrop-blur-md border border-white/20">
                  <p className="text-white/90 text-xs uppercase tracking-wider mb-1 font-bold">
                    {t("expense")}
                  </p>
                  <p className="text-lg font-bold">{getCurrencySymbol()}{formatCurrency(convertAmount(monthlyExpenseNum))}</p>
                </div>
              </div>
            </div>

            {/* Tabs */}
            <div className="flex px-8 mt-6 gap-6">
              <button
                onClick={() => setActiveTab("transactions")}
                className={`flex-1 pb-3 text-sm font-bold flex items-center justify-center gap-2 border-b-2 transition-all ${activeTab === "transactions"
                  ? "border-pink-500 text-pink-600"
                  : "border-transparent text-slate-400"
                  }`}
              >
                <List size={18} /> {t("transactions")}
              </button>
              <button
                onClick={() => setActiveTab("insights")}
                className={`flex-1 pb-3 text-sm font-bold flex items-center justify-center gap-2 border-b-2 transition-all ${activeTab === "insights"
                  ? "border-violet-500 text-violet-600"
                  : "border-transparent text-slate-400"
                  }`}
              >
                <PieChart size={18} /> {t("insights")}
              </button>
            </div>

            {/* Content */}
            <div
              className={`flex-1 overflow-y-auto p-6 pb-24 transition-colors duration-300 ${isDark ? "bg-slate-900" : "bg-white"
                }`}
            >
              {activeTab === "transactions" ? (
                <>
                  {/* Monthly Summary Card */}
                  <div
                    className={`mb-6 p-4 rounded-3xl border shadow-sm flex justify-between items-center ${isDark
                      ? "bg-slate-800 border-slate-700"
                      : "bg-slate-50 border-slate-100"
                      }`}
                  >
                    <div>
                      <h4
                        className={`text-sm font-bold mb-1 ${isDark ? "text-slate-200" : "text-slate-700"
                          }`}
                      >
                        {t("monthlySummary")}
                      </h4>
                      <p
                        className={`text-xs ${isDark ? "text-slate-400" : "text-slate-400"
                          }`}
                      >
                        {currentDate.toLocaleDateString(getDateLocale(), {
                          month: "long",
                          year: "numeric",
                        })}
                      </p>
                    </div>
                    <div className="text-right">
                      <p
                        className={`text-xs font-medium mb-0.5 ${isDark ? "text-slate-400" : "text-slate-500"
                          }`}
                      >
                        {t("netFlow")}
                      </p>
                      <p
                        className={`text-lg font-black ${monthlyIncomeNum - monthlyExpenseNum >= 0
                          ? "text-emerald-500"
                          : "text-rose-500"
                          }`}
                      >
                        {monthlyIncomeNum - monthlyExpenseNum >= 0 ? "+" : ""}
                        {getCurrencySymbol()}{formatCurrency(convertAmount(Math.abs(monthlyIncomeNum - monthlyExpenseNum)))}
                      </p>
                    </div>
                  </div>

                  <div className="flex justify-between items-end mb-4 px-2">
                    <h3
                      className={`text-lg font-bold ${isDark ? "text-slate-200" : "text-slate-700"
                        }`}
                    >
                      {t("recentActivity")}
                    </h3>
                    <span
                      className={`text-xs font-medium ${isDark ? "text-slate-500" : "text-slate-400"
                        }`}
                    >
                      {filteredTransactions.length} {t("records")}
                    </span>
                  </div>

                  {filteredTransactions.length === 0 ? (
                    <div
                      className={`text-center py-12 flex flex-col items-center justify-center ${isDark ? "text-slate-600" : "text-slate-300"
                        }`}
                    >
                      <div
                        className={`w-32 h-32 rounded-full flex items-center justify-center mb-4 transition-colors ${isDark ? "bg-slate-800" : "bg-slate-50"
                          }`}
                      >
                        <PompitSleeping size={80} className="opacity-80" />
                      </div>
                      <p className="font-medium">{t("noData")}</p>
                      <p className="text-xs mt-1">{t("addPrompt")}</p>
                    </div>
                  ) : (
                    <ul className="space-y-3">
                      {filteredTransactions.map((transaction) => {
                        const catDetails = getCategoryDetails(
                          transaction.category,
                          transaction.type
                        );
                        const Icon = catDetails.icon;
                        return (
                          <li
                            key={transaction.id}
                            className={`group border p-4 rounded-2xl shadow-sm flex justify-between items-center transition-all duration-300 ${isDark
                              ? "bg-slate-800 border-slate-700 hover:border-pink-500/30"
                              : "bg-slate-50 hover:bg-white border-transparent hover:border-pink-100 hover:shadow-lg hover:shadow-pink-500/10"
                              }`}
                          >
                            <div className="flex items-center gap-4">
                              <div
                                className={`w-12 h-12 rounded-full flex items-center justify-center shadow-sm ${isDark
                                  ? "bg-slate-700 text-slate-300"
                                  : `${catDetails.bg} ${catDetails.color}`
                                  }`}
                              >
                                <Icon size={20} />
                              </div>
                              <div>
                                <p
                                  className={`font-bold ${isDark
                                    ? "text-slate-200"
                                    : "text-slate-700"
                                    }`}
                                >
                                  {transaction.text}
                                </p>
                                <div
                                  className={`flex items-center gap-2 text-xs ${isDark
                                    ? "text-slate-500"
                                    : "text-slate-400"
                                    }`}
                                >
                                  <span
                                    className={`capitalize px-2 py-0.5 rounded-full border ${isDark
                                      ? "bg-slate-700 border-slate-600 text-slate-300"
                                      : "bg-white border-slate-100"
                                      }`}
                                  >
                                    {catDetails.label}
                                  </span>
                                  <span>{transaction.date}</span>
                                </div>
                              </div>
                            </div>
                            <div className="flex items-center gap-3">
                              <span
                                className={`font-bold ${transaction.type === "income"
                                  ? "text-emerald-500"
                                  : "text-rose-500"
                                  }`}
                              >
                                {transaction.type === "income" ? "+" : "-"}{getCurrencySymbol()}
                                {formatCurrency(convertAmount(Math.abs(transaction.amount), transaction.currency || 'KRW'))}
                              </span>
                              <button
                                onClick={() =>
                                  deleteTransaction(transaction.id)
                                }
                                className={`transition-colors p-2 ${isDark
                                  ? "text-slate-600 hover:text-rose-400"
                                  : "text-slate-300 hover:text-rose-500"
                                  }`}
                              >
                                <Trash2 size={16} />
                              </button>
                            </div>
                          </li>
                        );
                      })}
                    </ul>
                  )}
                </>
              ) : (
                <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-300">
                  <div
                    className={`p-6 rounded-3xl shadow-lg border ${isDark
                      ? "bg-slate-800 border-slate-700"
                      : "bg-white border-slate-100/50"
                      }`}
                  >
                    <h3
                      className={`text-lg font-bold mb-2 text-center ${isDark ? "text-slate-200" : "text-slate-700"
                        }`}
                    >
                      Income vs Expense
                    </h3>
                    <DonutChart />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div
                      className={`p-5 rounded-3xl border flex flex-col justify-between ${isDark
                        ? "bg-slate-800 border-slate-700"
                        : "bg-rose-50/50 border-rose-100"
                        }`}
                    >
                      <div className="flex items-start justify-between mb-3">
                        <div
                          className={`p-2.5 rounded-xl shadow-sm ${isDark
                            ? "bg-slate-700 text-rose-400"
                            : "bg-white text-rose-500"
                            }`}
                        >
                          <AlertCircle size={20} />
                        </div>
                      </div>
                      <div>
                        <p
                          className={`text-xs font-bold uppercase tracking-wider mb-1 ${isDark ? "text-rose-400" : "text-rose-400"
                            }`}
                        >
                          {t("biggestExpense")}
                        </p>
                        <p
                          className={`text-lg font-black truncate ${isDark ? "text-slate-200" : "text-slate-700"
                            }`}
                        >
                          {highestExpense.text}
                        </p>
                        <p className="text-sm font-bold text-rose-500">
                          -{getCurrencySymbol()}{formatCurrency(convertAmount(highestExpense.amount))}
                        </p>
                      </div>
                    </div>
                    <div
                      className={`p-5 rounded-3xl border flex flex-col justify-between ${isDark
                        ? "bg-slate-800 border-slate-700"
                        : "bg-blue-50/50 border-blue-100"
                        }`}
                    >
                      <div className="flex items-start justify-between mb-3">
                        <div
                          className={`p-2.5 rounded-xl shadow-sm ${isDark
                            ? "bg-slate-700 text-blue-400"
                            : "bg-white text-blue-500"
                            }`}
                        >
                          <List size={20} />
                        </div>
                      </div>
                      <div>
                        <p
                          className={`text-xs font-bold uppercase tracking-wider mb-1 ${isDark ? "text-blue-400" : "text-blue-400"
                            }`}
                        >
                          {t("txCount")}
                        </p>
                        <p
                          className={`text-lg font-black ${isDark ? "text-slate-200" : "text-slate-700"
                            }`}
                        >
                          {filteredTransactions.length}
                        </p>
                        <p
                          className={`text-xs font-medium ${isDark ? "text-slate-500" : "text-blue-400"
                            }`}
                        >
                          {t("totalItems")}
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* FAB Group */}
            <div className="absolute bottom-8 right-6 flex flex-col gap-4 items-end z-20">
              {/* Camera Button */}
              <button
                onClick={triggerCamera}
                className="w-12 h-12 bg-white text-slate-700 rounded-full shadow-lg shadow-slate-300/40 flex items-center justify-center hover:scale-105 transition-transform active:scale-95 border border-slate-100"
              >
                <Camera size={24} />
              </button>

              {/* Add Button */}
              <button
                onClick={openForm}
                className="w-16 h-16 bg-gradient-to-r from-pink-500 to-violet-500 text-white rounded-full shadow-lg shadow-pink-500/40 flex items-center justify-center hover:scale-105 transition-transform active:scale-95"
              >
                <Plus size={32} />
              </button>
            </div>

            {/* Scanning Overlay Modal */}
            {isScanning && (
              <div className="absolute inset-0 bg-slate-900/80 z-50 flex flex-col items-center justify-center animate-in fade-in duration-300">
                <div className="relative mb-6">
                  <div className="absolute inset-0 bg-blue-400/20 rounded-full animate-ping"></div>
                  <div className="w-32 h-32 bg-white rounded-full flex items-center justify-center relative overflow-hidden">
                    <div
                      className="absolute inset-0 bg-gradient-to-b from-transparent via-blue-200/20 to-transparent animate-[scan_1.5s_ease-in-out_infinite] translate-y-full"
                      style={{ animation: "scan 1.5s ease-in-out infinite" }}
                    ></div>
                    <PompitScanning size={80} />
                  </div>
                  <div className="absolute -bottom-2 -right-2 bg-white p-2 rounded-full shadow-lg">
                    <ScanLine
                      size={24}
                      className="text-blue-500 animate-pulse"
                    />
                  </div>
                </div>
                <h3 className="text-white text-xl font-bold mb-2 flex items-center gap-2">
                  {t("scanning")}{" "}
                  <Loader className="animate-spin" size={20} />
                </h3>
                <p className="text-white/70 text-sm">
                  Pompit is reading your receipt...
                </p>
              </div>
            )}

            {/* Budget Setting Modal */}
            {isBudgetOpen && (
              <div className="absolute inset-0 bg-slate-900/60 z-30 flex items-center justify-center backdrop-blur-sm animate-in fade-in duration-200 p-6">
                <div
                  className={`w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in zoom-in-95 duration-200 ${isDark ? "bg-slate-800" : "bg-white"
                    }`}
                >
                  <div className="flex justify-between items-center mb-6">
                    <h3
                      className={`text-xl font-bold flex items-center gap-2 ${isDark ? "text-white" : "text-slate-800"
                        }`}
                    >
                      <Target className="text-pink-500" /> {t("setBudget")}
                    </h3>
                    <button
                      onClick={() => setIsBudgetOpen(false)}
                      className={`p-2 rounded-full ${isDark
                        ? "bg-slate-700 text-slate-300"
                        : "bg-slate-100 text-slate-500"
                        }`}
                    >
                      <X size={20} />
                    </button>
                  </div>
                  <form onSubmit={saveBudget}>
                    <div className="mb-6">
                      <label
                        className={`block text-xs font-bold uppercase tracking-wider mb-2 ${isDark ? "text-slate-400" : "text-slate-500"
                          }`}
                      >
                        {t("monthlyLimit")} (‡∏ø)
                      </label>
                      <input
                        type="number"
                        value={tempBudget}
                        onChange={(e) => setTempBudget(e.target.value)}
                        className={`w-full p-4 text-2xl font-black rounded-2xl border-2 focus:outline-none transition-all ${isDark
                          ? "bg-slate-700 border-slate-600 text-white focus:border-pink-500"
                          : "bg-slate-50 border-slate-100 text-slate-800 focus:border-pink-500"
                          }`}
                        placeholder="0"
                        autoFocus
                      />
                    </div>
                    <button
                      type="submit"
                      className="w-full p-4 rounded-2xl font-bold text-white bg-gradient-to-r from-pink-500 to-violet-500 shadow-lg shadow-pink-500/30 hover:scale-[1.02] transition-transform"
                    >
                      {t("saveBudget")}
                    </button>
                  </form>
                </div>
              </div>
            )}

            {/* Currency Selector Modal */}
            {isCurrencyModalOpen && (
              <div className="absolute inset-0 bg-slate-900/60 z-30 flex items-center justify-center backdrop-blur-sm animate-in fade-in duration-200 p-6">
                <div
                  className={`w-full max-w-sm rounded-3xl p-6 shadow-2xl animate-in zoom-in-95 duration-200 ${isDark ? "bg-slate-800" : "bg-white"
                    }`}
                >
                  <div className="flex justify-between items-center mb-6">
                    <h3
                      className={`text-xl font-bold ${isDark ? "text-white" : "text-slate-800"
                        }`}
                    >
                      Select Currency
                    </h3>
                    <button
                      onClick={() => setIsCurrencyModalOpen(false)}
                      className={`p-2 rounded-full ${isDark
                        ? "bg-slate-700 text-slate-300"
                        : "bg-slate-100 text-slate-500"
                        }`}
                    >
                      <X size={20} />
                    </button>
                  </div>

                  <div className="space-y-3 mb-6">
                    {Object.entries(CURRENCIES).map(([code, info]) => (
                      <button
                        key={code}
                        onClick={() => setCurrency(code)}
                        className={`w-full p-4 rounded-2xl border-2 transition-all ${currency === code
                          ? "border-pink-500 bg-pink-50 dark:bg-pink-900/20"
                          : isDark
                            ? "border-slate-700 bg-slate-700/50 hover:border-slate-600"
                            : "border-slate-200 bg-slate-50 hover:border-slate-300"
                          }`}
                      >
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <span className="text-3xl">{info.flag}</span>
                            <div className="text-left">
                              <div
                                className={`font-bold ${currency === code
                                  ? "text-pink-600 dark:text-pink-400"
                                  : isDark
                                    ? "text-white"
                                    : "text-slate-800"
                                  }`}
                              >
                                {info.name}
                              </div>
                              <div
                                className={`text-sm ${isDark ? "text-slate-400" : "text-slate-500"
                                  }`}
                              >
                                {info.symbol} {code}
                              </div>
                            </div>
                          </div>
                          <div
                            className={`text-lg font-bold ${currency === code
                              ? "text-pink-600 dark:text-pink-400"
                              : isDark
                                ? "text-slate-300"
                                : "text-slate-600"
                              }`}
                          >
                            {info.symbol}{formatCurrency(convertAmount(parseFloat(globalBalance), 'KRW', code), code)}
                          </div>
                        </div>
                      </button>
                    ))}
                  </div>

                  {ratesLoading && (
                    <p className="text-xs text-center text-slate-400 mb-4">
                      <Loader className="animate-spin inline mr-1" size={12} />
                      Loading exchange rates...
                    </p>
                  )}

                  <button
                    onClick={() => setIsCurrencyModalOpen(false)}
                    className="w-full p-4 rounded-2xl font-bold text-white bg-gradient-to-r from-pink-500 to-violet-500 shadow-lg shadow-pink-500/30 hover:scale-[1.02] transition-transform"
                  >
                    Apply
                  </button>
                </div>
              </div>
            )}


            {/* Transaction Form Modal */}
            {isFormVisible && (
              <div className="absolute inset-0 bg-slate-900/60 z-30 flex items-end sm:items-center justify-center backdrop-blur-sm animate-in fade-in duration-200">
                <div
                  className={`w-full sm:w-[90%] sm:rounded-3xl rounded-t-[2.5rem] p-8 shadow-2xl animate-in slide-in-from-bottom duration-300 max-h-[90vh] overflow-y-auto transition-colors duration-300 ${isDark ? "bg-slate-800" : "bg-white"
                    }`}
                >
                  <div className="flex justify-between items-center mb-8">
                    <h3
                      className={`text-xl font-bold ${isDark ? "text-white" : "text-slate-800"
                        }`}
                    >
                      {t("newEntry")}
                    </h3>
                    <button
                      onClick={() => setIsFormVisible(false)}
                      className={`p-2 rounded-full transition-colors ${isDark
                        ? "bg-slate-700 text-slate-300 hover:bg-slate-600"
                        : "bg-slate-100 text-slate-500 hover:bg-slate-200"
                        }`}
                    >
                      <X size={20} />
                    </button>
                  </div>

                  <form onSubmit={addTransaction} className="space-y-6">
                    {/* Type Toggle */}
                    <div
                      className={`flex p-1.5 rounded-2xl ${isDark ? "bg-slate-700" : "bg-slate-100"
                        }`}
                    >
                      <button
                        type="button"
                        onClick={() => {
                          setFormType("expense");
                          setSelectedCategory("food");
                        }}
                        className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 ${formType === "expense"
                          ? `${isDark
                            ? "bg-slate-600 text-rose-400"
                            : "bg-white text-rose-500"
                          } shadow-sm`
                          : "text-slate-400 hover:text-slate-500"
                          }`}
                      >
                        {t("expense")}
                      </button>
                      <button
                        type="button"
                        onClick={() => {
                          setFormType("income");
                          setSelectedCategory("salary");
                        }}
                        className={`flex-1 py-3 rounded-xl text-sm font-bold transition-all duration-300 ${formType === "income"
                          ? `${isDark
                            ? "bg-slate-600 text-emerald-400"
                            : "bg-white text-emerald-600"
                          } shadow-sm`
                          : "text-slate-400 hover:text-slate-500"
                          }`}
                      >
                        {t("income")}
                      </button>
                    </div>

                    {/* Amount Input */}
                    <div className="relative">
                      <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                        {t("amount")}
                      </label>
                      <div className="relative">
                        <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-xl">
                          {getCurrencySymbol()}
                        </span>
                        <input
                          type="number"
                          value={amount}
                          onChange={(e) => setAmount(e.target.value)}
                          placeholder="0"
                          className={`w-full p-4 pl-10 border-2 border-transparent rounded-2xl focus:outline-none text-3xl font-black transition-all ${isDark
                            ? "bg-slate-700 text-white focus:bg-slate-600 focus:border-pink-500"
                            : "bg-slate-50 text-slate-700 focus:bg-white focus:border-pink-300"
                            }`}
                          autoFocus
                        />
                      </div>
                    </div>

                    {/* Category Grid */}
                    <div>
                      <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">
                        {t("category")}
                      </label>
                      <div className="grid grid-cols-4 gap-3">
                        {CATEGORIES[formType].map((cat) => {
                          const Icon = cat.icon;
                          const isSelected = selectedCategory === cat.id;
                          const label =
                            TRANSLATIONS[language][cat.id] || cat.id;

                          const inactiveBg = isDark
                            ? "bg-slate-700"
                            : "bg-white";
                          const inactiveBorder = isDark
                            ? "border-slate-600 hover:border-slate-500"
                            : "border-slate-100 hover:border-slate-200";

                          return (
                            <button
                              key={cat.id}
                              type="button"
                              onClick={() => setSelectedCategory(cat.id)}
                              className={`flex flex-col items-center gap-2 p-3 rounded-2xl transition-all border-2 ${isSelected
                                ? `border-pink-500 ${isDark ? "bg-slate-600" : "bg-pink-50"
                                }`
                                : `${inactiveBorder} ${inactiveBg}`
                                }`}
                            >
                              <div
                                className={`w-10 h-10 rounded-full flex items-center justify-center transition-colors ${isSelected
                                  ? "bg-pink-200 text-pink-700"
                                  : `${isDark
                                    ? "bg-slate-600 text-slate-400"
                                    : "bg-slate-100 text-slate-400"
                                  }`
                                  }`}
                              >
                                <Icon size={20} />
                              </div>
                              <span
                                className={`text-[10px] font-bold ${isSelected
                                  ? "text-pink-600"
                                  : "text-slate-400"
                                  }`}
                              >
                                {label}
                              </span>
                            </button>
                          );
                        })}
                      </div>
                    </div>

                    {/* Description Input */}
                    <div>
                      <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">
                        {t("note")}
                      </label>
                      <input
                        type="text"
                        value={text}
                        onChange={(e) => setText(e.target.value)}
                        placeholder={t("notePlaceholder")}
                        className={`w-full p-4 border-2 border-transparent rounded-2xl focus:outline-none font-medium transition-all ${isDark
                          ? "bg-slate-700 text-white focus:bg-slate-600 focus:border-pink-500"
                          : "bg-slate-50 text-slate-700 focus:bg-white focus:border-pink-300"
                          }`}
                      />
                    </div>

                    {/* Submit Button */}
                    <button
                      type="submit"
                      className={`w-full p-4 rounded-2xl font-bold text-white shadow-xl hover:shadow-2xl hover:scale-[1.02] transition-all active:scale-95 flex items-center justify-center gap-2 text-lg ${formType === "income"
                        ? "bg-gradient-to-r from-emerald-400 to-teal-500 shadow-emerald-500/30"
                        : "bg-gradient-to-r from-rose-400 to-pink-500 shadow-rose-500/30"
                        }`}
                    >
                      <Plus size={24} strokeWidth={3} />
                      {formType === "income"
                        ? t("addIncome")
                        : t("addExpense")}
                    </button>
                  </form>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    const root = createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>

  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/sw.js')
          .then((registration) => {
            console.log('‚úÖ Service Worker registered successfully:', registration.scope);

            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              console.log('üîÑ Service Worker update found');

              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('‚ú® New content available! Reload to update.');
                  // Optionally notify the user about the update
                }
              });
            });
          })
          .catch((error) => {
            console.error('‚ùå Service Worker registration failed:', error);
          });
      });
    } else {
      console.log('‚ö†Ô∏è Service Workers are not supported in this browser.');
    }
  </script>
</body>

</html>